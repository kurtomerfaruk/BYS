<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="jakarta.faces.facelets"
      xmlns:h="jakarta.faces.html"
      xmlns:f="jakarta.faces.core"
      xmlns:p="primefaces"
      xmlns:pe="primefaces.extensions">
<h:head>
    <style type="text/css">
        #pdfDialog {
            width: 100% !important;
            height: 100% !important;
            max-width: 100% !important;
        }

        .ui-sticky {
            top: 70px !important;
        }

        @media (max-width: 960px) {
            .ui-sticky {
                top: 110px !important;
            }
        }
    </style>
</h:head>
<h:body>
    <h:form id="raporForm">

        <p:importEnum type="tr.bel.gaziantep.bysweb.core.enums.bys.EnumRaporTuru" var="enumRaporTuru"/>

        <!-- Ana Container -->
        <p:panel header="Dinamik Rapor Oluşturma">

            <!-- Üst Menü -->
            <p:toolbar id="toolbar">
                <p:toolbarGroup align="right">
                    <p:outputLabel value="Rapor Türü :" for="@next" styleClass="me-2"/>
                    <p:selectOneMenu value="#{gnlRaporPrint.raporTuru}"
                                     required="true"
                                     style="display:inline-block !important; width:120px !important; vertical-align:middle;">
                        <f:selectItems value="#{enumRaporTuru.ALL_VALUES}"
                                       var="raporTurs"
                                       itemValue="#{raporTurs}"
                                       itemLabel="#{raporTurs.displayValue}"
                                       itemDisabled="#{raporTurs.name() ne 'PDF' and raporTurs.name() ne 'XLS' and raporTurs.name() ne 'CSV'}"/>
                        <p:ajax event="change" update="btnRapor"/>
                    </p:selectOneMenu>

                    <p:divider layout="vertical"/>

                    <p:commandButton id="btnRapor"
                                     icon="pi pi-file-pdf"
                                     title="Rapor Oluştur"
                                     actionListener="#{gnlRaporPrint.raporOlustur}"
                                     update="@form,:growl,:pdfForm"
                                     styleClass="ui-button-success me-2"
                                     ajax="#{gnlRaporPrint.raporTuru eq 'PDF'}"
                                     oncomplete="#{gnlRaporPrint.raporTuru eq 'PDF' ? 'PF(\'pdfDialogWidget\').show()' :''}"/>

                    <!--                    <p:commandButton onclick="PF('saveTemplateDialog').show()"-->
                    <!--                                     icon="pi pi-save"-->
                    <!--                                     title="Şablon Olarak Kaydet"-->
                    <!--                                     update=":growl,sablonForm"-->
                    <!--                                     styleClass="ui-button-info me-2"/>-->
                    <p:commandButton styleClass="ui-button-info me-2" icon="pi pi-save"
                                     title="Şablon Olarak Kaydet"
                                     actionListener="#{gnlRaporPrint.prepareSablon}"
                                     update=":sablonForm"
                                     oncomplete="PF('saveTemplateDialog').show()" onstart="PF('Loading').show()"
                                     onsuccess="PF('Loading').hide()"/>


                </p:toolbarGroup>
            </p:toolbar>

            <p:sticky target="toolbar"/>

            <p:divider/>

            <div class="grid">
                <div class="g-col-4">
                    <p:panel header="Rapor Ayarları">

                        <!-- Rapor Seçimi -->
                        <p:panel header="Rapor Seçimi" style="margin-bottom: 15px;">
                            <p:selectOneMenu value="#{gnlRaporPrint.selectedRapor}"
                                             required="true"
                                             requiredMessage="Lütfen bir rapor seçiniz" converter="omnifaces.SelectItemsConverter">
                                <f:selectItem itemLabel="Rapor Seçiniz..." itemValue="#{null}"/>
                                <f:selectItems value="#{gnlRaporController.items}"
                                               var="rapor"
                                               itemLabel="#{rapor.ad}"
                                               itemValue="#{rapor}"
                                               itemDescription="#{rapor.aciklama}"/>
                                <p:ajax listener="#{gnlRaporPrint.onReportChange}"
                                        update=":raporForm:kolonPanel,:raporForm:parametreDt,:sablonPanel,mainGrid"/>
                            </p:selectOneMenu>
                        </p:panel>

                        <!-- Kolon Seçimi -->
                        <p:panel id="kolonPanel" header="Kolonlar" style="margin-bottom: 15px;">
                            <p:dataTable id="kolonTablosu"
                                         value="#{gnlRaporPrint.secilebilirKolonlar}"
                                         var="kolon"
                                         selection="#{gnlRaporPrint.seciliKolonlar}"
                                         rowKey="#{kolon.id}"
                                         scrollable="true"
                                         scrollHeight="200"
                                         emptyMessage="Rapor seçiniz...">

                                <p:column selectionBox="true" style="width: 40px;text-align:left"/>

                                <p:column headerText="Kolon Adı">
                                    <h:outputText value="#{kolon.gorunurAdi}"/>
                                </p:column>

                                <p:column headerText="Veri Tipi" style="width: 100px">
                                    <h:outputText value="#{kolon.veriTipi}"/>
                                </p:column>

                                <f:facet name="footer">
                                    <p:commandButton value="Tümünü Seç"
                                                     onclick="selectAllColumnsTable()"
                                                     styleClass="ui-button-secondary"/>
                                    <p:commandButton value="Tümünü Temizle"
                                                     onclick="clearAllColumnsKolon()"
                                                     styleClass="ui-button-secondary"/>
                                </f:facet>
                            </p:dataTable>
                        </p:panel>

                        <!-- Şablonlar -->
                        <p:panel id="sablonPanel" header="Kayıtlı Şablonlar" styleClass="template-list">
                            <p:dataTable id="sablonDt" value="#{gnlRaporPrint.kullaniciSablonlari}"
                                         var="sablon"
                                         emptyMessage="Henüz şablonunuz yok"
                                         style="width: 100%"
                                         selectionDisabled="true">

                                <p:column headerText="Şablon Adı">
                                    <h:outputText value="#{sablon.sablonAdi}"/>
                                </p:column>

                                <p:column headerText="İşlemler" style="width: 120px">
                                    <p:commandButton icon="pi pi-upload"
                                                     title="Yükle"
                                                     action="#{gnlRaporPrint.sablonYukle(sablon.id)}"
                                                     process="@this"
                                                     update="@form,:growl"/>

                                    <p:commandButton id="deleteButton" styleClass="ui-button-danger" icon="pi pi-trash"
                                                     title="#{messages.buttonSil}"
                                                     actionListener="#{gnlRaporPrint.sablonSil(sablon.id)}"
                                                     update=":growl,:raporForm:templateTable,sablonDt"
                                                     process="@this">
                                        <p:confirm header="#{messages.ConfirmationHeader}" message="#{messages.ConfirmDeleteMessage}"
                                                   icon="pi pi-warning"/>
                                    </p:commandButton>
                                </p:column>
                            </p:dataTable>
                        </p:panel>

                    </p:panel>
                </div>
                <div class="g-col-8">
                    <p:panel header="Rapor Parametreleri">

                        <p:dataTable id="parametreDt"
                                     value="#{gnlRaporPrint.raporParametreleri}"
                                     var="paramVar"
                                     rowKey="#{paramVar.id}"
                                     emptyMessage="Rapor seçiniz veya bu Rapor için parametre tanımlanmamış"
                                     style="width: 100%">

                            <p:column headerText="Parametre" style="width: 35%">
                                <h:outputText value="#{paramVar.gorunurAdi}"/>
                                <h:outputText value=" *"
                                              style="color: red; font-weight: bold"
                                              rendered="#{paramVar.zorunlu}"/>
                            </p:column>

                            <p:column headerText="Operatör" style="width: 15%">
                                <p:selectOneMenu value="#{gnlRaporPrint.parametreOperatorleri[paramVar.id]}" style="width: 100%">
                                    <f:selectItem itemLabel="=" itemValue="="/>
                                    <f:selectItem itemLabel=">" itemValue="&gt;"/>
                                    <f:selectItem itemLabel="&lt;" itemValue="&lt;"/>
                                    <f:selectItem itemLabel="&gt;=" itemValue="&gt;="/>
                                    <f:selectItem itemLabel="&lt;=" itemValue="&lt;="/>
                                    <f:selectItem itemLabel="LIKE" itemValue="LIKE"/>
                                    <f:selectItem itemLabel="BETWEEN" itemValue="BETWEEN"/>
                                    <f:selectItem itemLabel="IN" itemValue="IN"/>
                                </p:selectOneMenu>
                            </p:column>

                            <p:column headerText="Değer" style="width: 25%">
                                <!-- Text Input -->
                                <p:inputText value="#{gnlRaporPrint.parametreDegerleri[paramVar.id]}"
                                             rendered="#{paramVar.veriTipi == 'STRING' or paramVar.veriTipi == 'INTEGER'}"
                                             required="#{paramVar.zorunlu}"/>

                                <!-- Date Input -->
                                <p:datePicker locale="tr" pattern="#{messages.tarihFormat}" value="#{gnlRaporPrint.parametreDegerleri[paramVar.id]}"
                                              mask="true" monthNavigator="true" yearNavigator="true" showButtonBar="true" showIcon="true"
                                              showOnFocus="false" rendered="#{paramVar.veriTipi == 'DATE'}" required="#{paramVar.zorunlu}"/>

                                <!-- DateTime Input -->
                                <p:datePicker locale="tr" pattern="#{messages.tarihSaatFormat}"
                                              value="#{gnlRaporPrint.parametreDegerleri[paramVar.id]}"
                                              mask="true" monthNavigator="true" yearNavigator="true" showButtonBar="true" showIcon="true"
                                              showOnFocus="false"
                                              rendered="#{paramVar.veriTipi == 'DATE_TIME'}" required="#{paramVar.zorunlu}"/>

                                <!-- Boolean Select -->
                                <p:selectOneMenu value="#{gnlRaporPrint.parametreDegerleri[paramVar.id]}"
                                                 rendered="#{paramVar.veriTipi == 'BOOLEAN'}"
                                                 required="#{paramVar.zorunlu}" title="#{paramVar.gorunurAdi}">
                                    <f:selectItem itemLabel="Seçiniz..." itemValue=""/>
                                    <f:selectItem itemLabel="Evet" itemValue="true"/>
                                    <f:selectItem itemLabel="Hayır" itemValue="false"/>
                                </p:selectOneMenu>

                                <!-- Lookup için select -->
                                <p:selectOneMenu value="#{gnlRaporPrint.parametreDegerleri[paramVar.id]}"
                                                 rendered="#{paramVar.lookupQuery != null}"
                                                 required="#{paramVar.zorunlu}">
                                    <f:selectItem itemLabel="Seçiniz..." itemValue=""/>
                                </p:selectOneMenu>

                                <!-- ENUM tipi için selectOneMenu -->
                                <p:selectOneMenu value="#{gnlRaporPrint.parametreDegerleri[paramVar.id]}" rendered="#{paramVar.veriTipi == 'ENUM'}"
                                                 required="#{paramVar.zorunlu}" title="#{paramVar.gorunurAdi}" label="#{paramVar.gorunurAdi}"
                                                 style="width:100% !important">
                                    <f:selectItems value="#{gnlRaporPrint.getEnumSelectItems(paramVar)}"
                                                   var="enumItem"
                                                   itemLabel="#{enumItem.label}"
                                                   itemValue="#{enumItem.value}"/>
                                </p:selectOneMenu>

                                <!-- MULTI_ENUM tipi için pickList -->
                                <p:pickList value="#{gnlRaporPrint.cokluEnumDegerleri[paramVar.id]}"
                                            rendered="#{paramVar.veriTipi == 'MULTI_ENUM'}"
                                            var="enumItem"
                                            itemLabel="#{enumItem.aciklama}"
                                            itemValue="#{enumItem.kod}"
                                            style="width: 100%; height: 100px" required="#{paramVar.zorunlu}">
                                    <f:selectItems value="#{gnlRaporPrint.getMultiEnumSelectItems(paramVar)}"/>
                                </p:pickList>
                            </p:column>

                            <p:column headerText="2. Değer" style="width: 25%">
                                <p:inputText value="#{gnlRaporPrint.ikinciDegerler[paramVar.id]}"
                                             rendered="#{gnlRaporPrint.parametreOperatorleri[paramVar.id] == 'BETWEEN'}"
                                             style="width: 100%"/>
                            </p:column>

                        </p:dataTable>

                    </p:panel>

                    <p:panel header="Özel Filtreler">

                        <p:dataTable id="ozelFiltreDt"
                                     value="#{gnlRaporOzelFiltreController.items}"
                                     var="ozelFiltreVar"
                                     selection="#{gnlRaporPrint.seciliOzelFiltreler}"
                                     rowKey="#{ozelFiltreVar.id}"
                                     lazy="false"
                                     scrollable="true"
                                     scrollHeight="200"
                                     emptyMessage="Tanımlı herhangi bir özel filtre bulunamadı.">

                            <p:column selectionBox="true" style="width: 40px;text-align:left"/>

                            <p:column headerText="Filtre Adı">
                                <h:outputText value="#{ozelFiltreVar.filtreAdi}"/>
                            </p:column>

                            <p:column headerText="Açıklama">
                                <h:outputText value="#{ozelFiltreVar.aciklama}"/>
                            </p:column>

                            <p:column headerText="SQL Koşulu">
                                <h:outputText value="#{ozelFiltreVar.sqlKosulu}"/>
                            </p:column>


                            <f:facet name="footer">
                                <p:commandButton value="Tümünü Seç"
                                                 onclick="selectAllColumnsCustomFilter()"
                                                 styleClass="ui-button-secondary"/>
                                <p:commandButton value="Tümünü Temizle"
                                                 onclick="clearAllColumnsCustomFilter()"
                                                 styleClass="ui-button-secondary"/>
                            </f:facet>
                        </p:dataTable>

                    </p:panel>
                </div>
            </div>
        </p:panel>
        <ui:include src="/confirmation.xhtml"/>

    </h:form>

    <!-- Şablon Kaydetme Dialog -->
    <p:dialog header="Şablon Kaydet"
              widgetVar="saveTemplateDialog"
              modal="true"
              resizable="false"
              appendTo="@(body)"
              responsive="true"
              closeOnEscape="true"
              style="width: 400px">

        <h:form id="sablonForm">

            <h:panelGroup id="display">
                <p:focus context="display"/>
                <p:panelGrid columns="2" rendered="#{gnlRaporPrint.kullaniciRaporSablon!=null}" layout="tabular">

                    <p:outputLabel value="#{messages.raporLabel}" for="@next"/>
                    <p:inputText value="#{gnlRaporPrint.kullaniciRaporSablon.gnlRapor.ad}" readonly="true" size="50"/>

                    <p:outputLabel value="#{messages.kullaniciLabel}" for="@next"/>
                    <p:inputText value="#{gnlRaporPrint.kullaniciRaporSablon.syKullanici.gnlPersonel.gnlKisi.adSoyad}" readonly="true"/>


                    <p:outputLabel value="Şablon Adı:" for="@next"/>
                    <p:inputText id="templateName" value="#{gnlRaporPrint.kullaniciRaporSablon.sablonAdi}"/>

                    <p:outputLabel value="#{messages.genelLabel}" for="@next"/>
                    <p:selectBooleanCheckbox id="genel" value="#{gnlRaporPrint.kullaniciRaporSablon.genel}"/>

                    <f:facet name="footer">
                        <div class="float-end">
                            <p:commandButton icon="pi pi-check" styleClass="ui-button-success"
                                             actionListener="#{gnlRaporPrint.sablonKaydet}"
                                             value="#{messages.buttonKaydet}"
                                             update=":raporForm:sablonDt,:growl,display"
                                             oncomplete="handleSubmit(xhr,status,args,PF('saveTemplateDialog'));"
                                             onstart="PF('Loading').show()" onsuccess="PF('Loading').hide()"/>
                            <p:commandButton icon="pi pi-times" styleClass="ui-button-danger"
                                             value="#{messages.buttonIptal}"
                                             onclick="PF('saveTemplateDialog').hide()" immediate="true"
                                             onstart="PF('Loading').show()" onsuccess="PF('Loading').hide()">
                                <p:resetInput target="@form"/>
                            </p:commandButton>
                        </div>
                    </f:facet>
                </p:panelGrid>
            </h:panelGroup>

        </h:form>
    </p:dialog>

    <p:dialog id="pdfDialog"
              widgetVar="pdfDialogWidget"
              closeOnEscape="true"
              appendTo="@(body)"
              header="Yazdır"
              modal="true"
              resizable="false"
              onShow="resizeViewer();"
              draggable="false"
              responsive="true"
              styleClass="box box-pink"
              minHeight="400"
              fitViewport="true">

        <h:form id="pdfForm" style="height: 100%">
            <p:remoteCommand name="updateViewer" update="viewer"/>

            <!--            <pe:documentViewer id="viewer" value="#{gnlRaporController.pdfContent}" download="Rapor.pdf" zoom="auto" transient="true"/>-->
            <pe:documentViewer id="viewer" url="/gnlDinamikReportServlet" download="Rapor.pdf" zoom="auto" transient="true"
                               rendered="#{gnlRaporPrint.pdfReady}"/>


        </h:form>

    </p:dialog>

    <script type="text/javascript">
        function selectAllColumnsTable() {
            $('[id$="kolonTablosu"] .ui-chkbox-box').each(function () {
                if (!$(this).hasClass('ui-state-active')) {
                    $(this).click();
                }
            });
        }

        function clearAllColumnsKolon() {
            $('[id$="kolonTablosu"] .ui-chkbox-box').each(function () {
                if ($(this).hasClass('ui-state-active')) {
                    $(this).click();
                }
            });
        }

        function selectAllColumnsCustomFilter() {
            $('[id$="ozelFiltreDt"] .ui-chkbox-box').each(function () {
                if (!$(this).hasClass('ui-state-active')) {
                    $(this).click();
                }
            });
        }

        function clearAllColumnsCustomFilter() {
            $('[id$="ozelFiltreDt"] .ui-chkbox-box').each(function () {
                if ($(this).hasClass('ui-state-active')) {
                    $(this).click();
                }
            });
        }

        function resizeViewer() {
            console.log("resizeViewer");
            var windowH = $(window).height();
            windowH -= 150;
            $("#pdfForm\\:viewer").css("height", windowH + "px");
        }
    </script>

</h:body>
</html>